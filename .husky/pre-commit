#!/usr/bin/env sh
# Pre-commit hook for @mux/ai
# Automatically installed by Husky during npm install

. "$(dirname -- "$0")/_/husky.sh"

echo "๐ Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Get staged TypeScript/JavaScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|mjs)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "${GREEN}โ No TypeScript/JavaScript files to check${NC}"
  exit 0
fi

FILE_COUNT=$(echo "$STAGED_FILES" | wc -l | tr -d ' ')
echo "๐ Checking ${YELLOW}${FILE_COUNT}${NC} staged file(s)"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Run ESLint (handles formatting, code quality, filename conventions, etc.)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐งน Running ESLint..."
if echo "$STAGED_FILES" | xargs npx eslint --max-warnings=0; then
  echo "${GREEN}โ ESLint passed${NC}"
else
  echo "${RED}โ ESLint failed${NC}"
  echo ""
  echo "${YELLOW}๐ก Run 'npm run lint:fix' to auto-fix issues${NC}"
  exit 1
fi
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# Run TypeScript type checking (not handled by ESLint)
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo "๐ Running TypeScript type check..."
if npm run typecheck --silent; then
  echo "${GREEN}โ Type check passed${NC}"
else
  echo "${RED}โ Type check failed${NC}"
  exit 1
fi
echo ""

echo "${GREEN}โ All pre-commit checks passed!${NC}"
echo ""
