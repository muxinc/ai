#!/usr/bin/env sh
# Pre-commit hook for @mux/ai
# Automatically installed by Husky during npm install
#
# Styling standards enforced:
# - ESLint with @antfu/eslint-config
#   - 2 space indentation
#   - Semicolons required
#   - Double quotes
#   - 1TBS brace style (cuddled else)
#   - Import sorting (perfectionist)
#   - kebab-case filenames
#   - No process.env access (use config)
# - TypeScript strict type checking
# - No console.log in production code

. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get staged TypeScript/JavaScript files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|mjs)$' || true)

if [ -z "$STAGED_FILES" ]; then
  echo "${GREEN}âœ… No TypeScript/JavaScript files to check${NC}"
  exit 0
fi

FILE_COUNT=$(echo "$STAGED_FILES" | wc -l | tr -d ' ')
echo "ğŸ“ Checking ${YELLOW}${FILE_COUNT}${NC} staged file(s)"
echo ""

# Store overall status
CHECKS_PASSED=true

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Check 1: ESLint (formatting + code quality)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "${BLUE}1. Running ESLint...${NC}"
if echo "$STAGED_FILES" | xargs npx eslint --max-warnings=0 2>&1; then
  echo "${GREEN}   âœ“ ESLint passed${NC}"
else
  echo "${RED}   âœ— ESLint failed${NC}"
  echo "${YELLOW}   ğŸ’¡ Run 'npm run lint:fix' to auto-fix issues${NC}"
  CHECKS_PASSED=false
fi
echo ""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Check 2: TypeScript type checking
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "${BLUE}2. Running TypeScript type check...${NC}"
if npm run typecheck --silent 2>&1 | grep -v "^$"; then
  echo "${GREEN}   âœ“ Type check passed${NC}"
else
  echo "${RED}   âœ— Type check failed${NC}"
  CHECKS_PASSED=false
fi
echo ""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Check 3: Filename conventions
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "${BLUE}3. Checking filename conventions...${NC}"
BAD_FILENAMES=""
for file in $STAGED_FILES; do
  filename=$(basename "$file")
  # Skip special files
  if [ "$filename" = "README.md" ] || echo "$filename" | grep -q "\.d\.ts$"; then
    continue
  fi

  # Check if filename is kebab-case
  if ! echo "$filename" | grep -qE '^[a-z0-9]+(-[a-z0-9]+)*\.(ts|tsx|js|jsx|mjs)$'; then
    BAD_FILENAMES="${BAD_FILENAMES}\n   ${file}"
  fi
done

if [ -n "$BAD_FILENAMES" ]; then
  echo "${RED}   âœ— Files must use kebab-case:${NC}"
  printf "${YELLOW}%b${NC}\n" "$BAD_FILENAMES"
  CHECKS_PASSED=false
else
  echo "${GREEN}   âœ“ All filenames follow kebab-case${NC}"
fi
echo ""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Check 4: Detect console.log (warning only)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
echo "${BLUE}4. Checking for console.log statements...${NC}"
CONSOLE_LOGS=$(echo "$STAGED_FILES" | xargs grep -n "console\.log\|console\.debug" 2>/dev/null || true)
if [ -n "$CONSOLE_LOGS" ]; then
  echo "${YELLOW}   âš  Warning: console.log/debug found (discouraged):${NC}"
  echo "$CONSOLE_LOGS" | head -5
  COUNT=$(echo "$CONSOLE_LOGS" | wc -l | tr -d ' ')
  if [ "$COUNT" -gt 5 ]; then
    REMAINING=$((COUNT - 5))
    echo "${YELLOW}   ... and ${REMAINING} more${NC}"
  fi
else
  echo "${GREEN}   âœ“ No console.log/debug statements${NC}"
fi
echo ""

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Final verdict
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if [ "$CHECKS_PASSED" = "true" ]; then
  echo "${GREEN}âœ… All pre-commit checks passed!${NC}"
  echo ""
  exit 0
else
  echo "${RED}âŒ Pre-commit checks failed${NC}"
  echo ""
  echo "Fix the errors above and try again."
  echo "To bypass (not recommended): git commit --no-verify"
  echo ""
  exit 1
fi
